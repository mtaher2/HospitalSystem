<%- include('../partials/header', {title: 'Appointments', stylesheetName: 'styles', headerTitle: 'Appointments' }) %>
<%- include('../partials/patientNav') %>

<div class="medication-container">
<div id="confirmation-modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <p>Are you sure you want to cancel this appointment?</p>
    <div class="modal-buttons">
      <button id="confirm-cancel" class="modal-btn confirm">Yes</button>
      <button id="cancel-cancel" class="modal-btn cancel">No</button>
    </div>
  </div>
</div>

  <div class="top-strip"></div>
  <div class="tabs">
    <div
      class="tab <%= activeTab === 'upcoming' ? 'active' : '' %>"
      onclick="location.href='/appointments?activeTab=upcoming'"
    >
      upcoming
    </div>
    <div
      class="tab <%= activeTab === 'missed' ? 'active' : '' %>"
      onclick="location.href='/appointments?activeTab=missed'"
    >
      missed
    </div>
  </div>
  

  <div class="content-body">
    <% if (activeTab === 'upcoming') { %>
      <div class="table-wrapper">
        <table>
          <% if (appointments && appointments.length > 0) { %>
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Doctor</th>
              <th>Room</th>
              <th>Floor</th>
            </tr>
          </thead>
          <tbody>
            <% appointments.forEach(appointment => { %>
            <tr>
              <td><%= appointment.date %></td>
              <td><%= appointment.time %></td>
              <td><%= appointment.doctorName %></td>
              <td><%= appointment.roomID %></td>
              <td><%= appointment.floorNumber %></td>
              <td class="pay-btn-cell">
                <button
                  class="pay-btn cancel"
                  data-id="<%= appointment.appointmentID %>"
                >
                  Cancel
                </button>
              </td>
              <td class="pay-btn-cell">
                <button class="pay-btn">Reschedule</button>
              </td>
            </tr>
            <% }); %>
          </tbody>
          <% } else { %>
          <thead>
            <tr>
              <th colspan="7">No upcoming appointments found</th>
            </tr>
          </thead>
          <tbody style="display: none">
          </tbody>
          <% } %>
        </table>
      </div>
    <% } else if (activeTab === 'missed') { %>
      <div class="table-wrapper">
        <table>
          <% if (Cancelappointments && Cancelappointments.length > 0) { %>
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Doctor</th>
              <th>Room</th>
              <th>Floor</th>
            </tr>
          </thead>
          <tbody>
            <% Cancelappointments.forEach(appointment => { %>
            <tr>
              <td><%= appointment.date %></td>
              <td><%= appointment.time %></td>
              <td><%= appointment.doctorName %></td>
              <td><%= appointment.roomID %></td>
              <td><%= appointment.floorNumber %></td>
              <td class="pay-btn-cell">
                <button
                  class="pay-btn reschedule"
                  data-id="<%= appointment.appointmentID %>"
                >
                  Reschedule
                </button>
              </td>
            </tr>
            <% }); %>
          </tbody>
          <% } else { %>
          <thead>
            <tr>
              <th colspan="6">No missed appointments found</th>
            </tr>
          </thead>
          <tbody style="display: none">
          </tbody>
          <% } %>
        </table>
      </div>
    <% } %>
    
  </div>
  
  
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    let appointmentIdToCancel = null;

    function showCancelModal(appointmentId) {
      appointmentIdToCancel = appointmentId;
      const modal = document.getElementById("confirmation-modal");
      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false"); 
    }

    function closeModal() {
      const modal = document.getElementById("confirmation-modal");
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true"); 
      appointmentIdToCancel = null; 
    }

    document
      .getElementById("confirm-cancel")
      .addEventListener("click", async () => {
        if (appointmentIdToCancel) {
          const button = document.getElementById("confirm-cancel");
          button.disabled = true; 
          button.textContent = "Cancelling...";

          try {
            const response = await fetch(
              `/appointments/${appointmentIdToCancel}/cancel`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              }
            );

            if (response.ok) {
              document
                .querySelector(`[data-id='${appointmentIdToCancel}']`)
                .closest("tr")
                .remove();
              closeModal();
            } else {
              alert("Failed to cancel the appointment. Please try again.");
            }
          } catch (error) {
            console.error("Error canceling appointment:", error);
            alert("An error occurred. Please try again later.");
          } finally {
            button.disabled = false;
            button.textContent = "Yes";
          }
        }
      });

    document
      .getElementById("cancel-cancel")
      .addEventListener("click", closeModal);

    document.querySelector("table").addEventListener("click", (event) => {
      if (event.target.classList.contains("cancel")) {
        const appointmentId = event.target.dataset.id;
        if (appointmentId) {
          showCancelModal(appointmentId);
        }
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeModal();
      }
    });

    document
      .getElementById("confirmation-modal")
      .addEventListener("click", (event) => {
        if (event.target.id === "confirmation-modal") {
          closeModal();
        }
      });
  });
</script>

<script src="js/main.js"></script>
<%- include('../partials/footer') %>
