<%- include('../partials/header', { title: 'Patient Profile', stylesheetName: 'styles', headerTitle: 'Patient Profile' }) %>
<%-include('../partials/patientNav') %>


<div class="container-patient">
  <div class="profile-section">
    <div class="profile-info">
      <img
        src="<%= user.profile_photo || '/images/placeholder-avatar.png' %>"
        alt="Patient Avatar"
        class="avatar"
        onclick="openProfilePhotoModal()"
      />
      <div class="profile-info-detail">
        <h2><%= user.FName %> <%= user.LName %></h2>
        <p><%= age %> | <%= user.Gender %></p>
        <% if (user.Role === 6) { %>
          <div class="profile-buttons">
            <a href="/update-patient" class="appointment-btn">
              Update Profile
              <span
                ><i class="fa-solid fa-edit" style="color: #ffffff"></i>
              </span>
            </a>
            <a href="#" class="appointment-btn" onclick="openResetPasswordModal()">
              Reset Password
              <span
                ><i class="fa-solid fa-key" style="color: #ffffff"></i>
              </span>
            </a>
          </div>
        <% } %>
        <div style="display: flex; justify-content: start; width: 55%;">
          <a href="/addAppointment" class="appointment-btn">
            Make Appointment
            <span
              ><i class="fa-regular fa-square-plus" style="color: #ffffff"></i
            ></span>
          </a>
        </div>
      </div>
    </div>

    <div id="profilePhotoModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeProfilePhotoModal()"
          >&times;</span
        >
        <h2>Change Profile Photo</h2>
        <input type="file" id="profilePhotoInput" accept="image/*" />
        <button onclick="uploadProfilePhoto()" class="btn-upload">
          Upload
        </button>
      </div>
    </div>

    <div id="resetPasswordModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeResetPasswordModal()">&times;</span>
        <h2>Reset Password</h2>
        <p>Are you sure you want to reset your password? A new password will be sent to your email.</p>
        <div class="modal-buttons">
          <button onclick="resetPassword()" class="btn-confirm">Confirm Reset</button>
          <button onclick="closeResetPasswordModal()" class="btn-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <div class="details">
      <div class="left-details">
        <div class="info-item">
          <strong>National ID:</strong> <%= user.National_ID %>
        </div>
        <p class="section-title">Contact Info</p>
        <div class="info-item">
          <i class="fas fa-phone"></i>
          <strong>Phone:</strong> <%= user.Phone %>
        </div>
        <div class="info-item">
          <i class="fas fa-envelope"></i>
          <strong>Email:</strong> <%= user.Email %>
        </div>
        <div class="info-item">
          <i class="fas fa-map-marker-alt"></i>
          <strong>Address:</strong> <%= user.Address %>
        </div>
      </div>

      <% if (insurance !== null) { %>
      <div class="right-details">
        <p class="section-title">Insurance</p>
        <div class="info-item">
          <strong>Organization:</strong> <%= insurance.Insurance_Provider %>
        </div>
        <div class="info-item">
          <strong>Coverage:</strong> <%= insurance.Insurance_Coverage %>%
        </div>
        <div class="info-item">
          <strong>Expire Date:</strong> <%= insurance.Expiry_Date %>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>


<script>
  function openProfilePhotoModal() {
    document.getElementById("profilePhotoModal").style.display = "block";
  }

  function closeProfilePhotoModal() {
    document.getElementById("profilePhotoModal").style.display = "none";
  }

  function openResetPasswordModal() {
    document.getElementById("resetPasswordModal").style.display = "block";
  }

  function closeResetPasswordModal() {
    document.getElementById("resetPasswordModal").style.display = "none";
  }

  function resetPassword() {
    fetch('/reset-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Password reset successful! A new password has been sent to your email.');
        closeResetPasswordModal();
      } else {
        alert('Failed to reset password: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while resetting your password. Please try again later.');
    });
  }
</script>
<script src="js/upload.js"></script>
<script src="js/main.js"></script>
<%- include('../partials/footer') %>
